Upstream: posted for review https://git.reviewboard.kde.org/r/118439/

From edea1fc486a640eb0a1352b9a8b1b9446aa6f779 Mon Sep 17 00:00:00 2001
From: Heiko Becker <heirecka@exherbo.org>
Date: Sat, 31 May 2014 12:42:28 +0200
Subject: [PATCH] Install as a framework to make baloo coinstallable

---
 CMakeLists.txt                                  | 28 ++++++++++++----
 BalooConfig.cmake.in => KF5BalooConfig.cmake.in |  9 +++---
 src/core/CMakeLists.txt                         | 43 ++++++++++++++++---------
 src/core/autotests/CMakeLists.txt               |  2 +-
 src/core/tests/CMakeLists.txt                   |  2 +-
 src/file/CMakeLists.txt                         |  2 +-
 src/file/lib/CMakeLists.txt                     | 43 ++++++++++++++++---------
 src/file/lib/autotests/CMakeLists.txt           | 10 +++---
 src/xapian/CMakeLists.txt                       | 15 +++++----
 9 files changed, 96 insertions(+), 58 deletions(-)
 rename BalooConfig.cmake.in => KF5BalooConfig.cmake.in (81%)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index c8335d3..a945395 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -17,6 +17,7 @@ include(FeatureSummary)
 include(KDEInstallDirs)
 include(KDECMakeSettings)
 include(KDECompilerSettings)
+include(ECMGenerateHeaders)
 
 # Temporary option untill kdepimlibs is ok. Activate it if you want to compile kdepim
 option(KDEPIM_SUPPORT_BUILD "Build baloo kdepim support" FALSE)
@@ -57,7 +58,7 @@ kde_enable_exceptions()
 set(KF5_VERSION "5.0.0")
 ecm_setup_version(${KF5_VERSION} VARIABLE_PREFIX BALOO
                         VERSION_HEADER "${CMAKE_CURRENT_BINARY_DIR}/baloo_version.h"
-                        PACKAGE_VERSION_FILE "${CMAKE_CURRENT_BINARY_DIR}/BalooConfigVersion.cmake")
+                        PACKAGE_VERSION_FILE "${CMAKE_CURRENT_BINARY_DIR}/KF5BalooConfigVersion.cmake")
 
 include_directories(
   ${XAPIAN_INCLUDE_DIR}
@@ -72,14 +73,27 @@ include_directories(
 add_subdirectory(src)
 add_subdirectory(icons)
 
-configure_file(${CMAKE_CURRENT_SOURCE_DIR}/BalooConfig.cmake.in
-               ${CMAKE_CURRENT_BINARY_DIR}/BalooConfig.cmake @ONLY)
+# Config files
+set(CMAKECONFIG_INSTALL_DIR "${CMAKECONFIG_INSTALL_PREFIX}/KF5Baloo")
 
-install(FILES ${CMAKE_CURRENT_BINARY_DIR}/BalooConfig.cmake ${CMAKE_CURRENT_BINARY_DIR}/BalooConfigVersion.cmake
-        DESTINATION ${LIB_INSTALL_DIR}/cmake/Baloo)
+include(ECMPackageConfigHelpers)
+
+ecm_configure_package_config_file(
+    "${CMAKE_CURRENT_SOURCE_DIR}/KF5BalooConfig.cmake.in"
+    "${CMAKE_CURRENT_BINARY_DIR}/KF5BalooConfig.cmake"
+    INSTALL_DESTINATION ${CMAKECONFIG_INSTALL_DIR}
+)
+
+install(FILES
+    "${CMAKE_CURRENT_BINARY_DIR}/KF5BalooConfig.cmake"
+    "${CMAKE_CURRENT_BINARY_DIR}/KF5BalooConfigVersion.cmake"
+    DESTINATION ${CMAKECONFIG_INSTALL_DIR}
+    COMPONENT devel
+)
 install(EXPORT BalooLibraryTargets
-        DESTINATION ${LIB_INSTALL_DIR}/cmake/Baloo
-        FILE BalooTargetsWithPrefix.cmake)
+        NAMESPACE KF5::
+        DESTINATION ${LIB_INSTALL_DIR}/cmake/KF5Baloo
+        FILE KF5BalooTargetsWithPrefix.cmake)
 
 
 feature_summary(WHAT ALL
diff --git a/BalooConfig.cmake.in b/KF5BalooConfig.cmake.in
similarity index 81%
rename from BalooConfig.cmake.in
rename to KF5BalooConfig.cmake.in
index d389bfd..f1d3f17 100644
--- a/BalooConfig.cmake.in
+++ b/KF5BalooConfig.cmake.in
@@ -19,14 +19,13 @@ set(BALOO_INSTALL_PREFIX "${rootDir}")
 set(BALOO_INCLUDE_DIR "@INCLUDE_INSTALL_DIR@")
 set(Baloo_FOUND true)
 
-include(${_currentDir}/BalooTargetsWithPrefix.cmake)
+include(${_currentDir}/KF5BalooTargetsWithPrefix.cmake)
 
-set(BALOO_CORE_LIBRARY baloocore)
-set(BALOO_FILE_LIBRARY baloofiles)
+set(BALOO_CORE_LIBRARY KF5::BalooCore)
+set(BALOO_FILE_LIBRARY KF5::BalooFiles)
 set(BALOO_PIM_LIBRARY baloopim)
 set(BALOO_QUERYPARSER_LIBRARY balooqueryparser)
 #set(BALOO_TAG_LIBRARY balootags)
 
 # Set the library variable
-set(BALOO_LIBRARIES ${BALOO_CORE_LIBRARY} ${BALOO_FILE_LIBRARY} ${BALOO_PIM_LIBRARY}) 
-
+set(BALOO_LIBRARIES KF5::BalooCore KF5::BalooFiles ${BALOO_PIM_LIBRARY})
diff --git a/src/core/CMakeLists.txt b/src/core/CMakeLists.txt
index 844100f..805829d 100644
--- a/src/core/CMakeLists.txt
+++ b/src/core/CMakeLists.txt
@@ -9,37 +9,48 @@ set(CORE_SRCS
     result.cpp
 )
 
-add_library(baloocore SHARED ${CORE_SRCS})
+add_library(KF5BalooCore SHARED ${CORE_SRCS})
 
-target_link_libraries(baloocore PUBLIC Qt5::Core)
-target_link_libraries(baloocore PRIVATE
+add_library(KF5::BalooCore ALIAS KF5BalooCore)
+
+target_link_libraries(KF5BalooCore PUBLIC Qt5::Core)
+target_link_libraries(KF5BalooCore PRIVATE
     KF5::Service
     ${XAPIAN_LIBRARIES}
 )
 
-set_target_properties(baloocore PROPERTIES
+set_target_properties(KF5BalooCore PROPERTIES
     VERSION ${BALOO_VERSION_STRING}
     SOVERSION ${BALOO_SOVERSION}
+    EXPORT_NAME BalooCore
 )
+target_include_directories(KF5BalooCore INTERFACE "$<INSTALL_INTERFACE:${KF5_INCLUDE_INSTALL_DIR}/Baloo>")
 
-generate_export_header(baloocore BASE_NAME BALOO_CORE EXPORT_FILE_NAME core_export.h)
+generate_export_header(KF5BalooCore BASE_NAME BALOO_CORE EXPORT_FILE_NAME core_export.h)
 
-install(TARGETS baloocore EXPORT BalooLibraryTargets ${INSTALL_TARGETS_DEFAULT_ARGS})
+ecm_generate_headers(KF5BalooCore_HEADERS
+    HEADER_NAMES
+    Term
+    Query
+    QueryRunnable
+    Result
+    ResultIterator
+    SearchStore
 
-install(FILES
-    term.h
-    query.h
-    queryrunnable.h
-    result.h
-    resultiterator.h
-    searchstore.h
+    REQUIRED_HEADERS KF5BalooCore_HEADERS
+)
 
-    ${CMAKE_CURRENT_BINARY_DIR}/core_export.h
+install(TARGETS KF5BalooCore ${INSTALL_TARGETS_DEFAULT_ARGS})
 
-    DESTINATION ${INCLUDE_INSTALL_DIR}/baloo COMPONENT Devel
+install(TARGETS KF5BalooCore EXPORT BalooLibraryTargets ${INSTALL_TARGETS_DEFAULT_ARGS})
+install(FILES baloosearchstore.desktop DESTINATION ${SERVICETYPES_INSTALL_DIR})
+
+install(FILES
+    ${CMAKE_CURRENT_BINARY_DIR}/core_export.h
+    ${KF5BalooCore_HEADERS}
+    DESTINATION ${KF5_INCLUDE_INSTALL_DIR}/Baloo COMPONENT Devel
 )
 
-install(FILES baloosearchstore.desktop DESTINATION ${SERVICETYPES_INSTALL_DIR})
 
 add_subdirectory(tests)
 add_subdirectory(autotests)
diff --git a/src/core/autotests/CMakeLists.txt b/src/core/autotests/CMakeLists.txt
index d03b0a7..ca8e71f 100644
--- a/src/core/autotests/CMakeLists.txt
+++ b/src/core/autotests/CMakeLists.txt
@@ -7,6 +7,6 @@ set(querySerialization_SRC queryserializationtest.cpp)
 
 ecm_add_test(${querySerialization_SRC}
     TEST_NAME "queryserializationtest"
-    LINK_LIBRARIES Qt5::Test baloocore
+    LINK_LIBRARIES Qt5::Test KF5::BalooCore
 )
 
diff --git a/src/core/tests/CMakeLists.txt b/src/core/tests/CMakeLists.txt
index f505379..6b5bd52 100644
--- a/src/core/tests/CMakeLists.txt
+++ b/src/core/tests/CMakeLists.txt
@@ -6,5 +6,5 @@ add_executable(querytest querytest.cpp)
 
 target_link_libraries(querytest
   Qt5::Core
-  baloocore
+  KF5::BalooCore
 )
diff --git a/src/file/CMakeLists.txt b/src/file/CMakeLists.txt
index 318b289..48e6205 100644
--- a/src/file/CMakeLists.txt
+++ b/src/file/CMakeLists.txt
@@ -2,7 +2,7 @@ kde_enable_exceptions()
 
 add_subdirectory(lib)
 
-if (NOT BALOO_LIBRARIES_ONLY
+if (NOT BALOO_LIBRARIES_ONLY)
     add_subdirectory(search)
 
     set(file_SRCS
diff --git a/src/file/lib/CMakeLists.txt b/src/file/lib/CMakeLists.txt
index 9bfafde..044bc04 100644
--- a/src/file/lib/CMakeLists.txt
+++ b/src/file/lib/CMakeLists.txt
@@ -15,42 +15,53 @@ set(FILE_LIB_SRCS
     filecustommetadata.cpp
 )
 
-add_library(baloofiles SHARED ${FILE_LIB_SRCS})
+add_library(KF5BalooFiles SHARED ${FILE_LIB_SRCS})
+add_library(KF5::BalooFiles ALIAS KF5BalooFiles)
 
-target_link_libraries(baloofiles PUBLIC
+
+target_link_libraries(KF5BalooFiles PUBLIC
     Qt5::Core
     KF5::CoreAddons
 )
-target_link_libraries(baloofiles PRIVATE
+target_link_libraries(KF5BalooFiles PRIVATE
     KF5::FileMetaData
     KF5::ConfigCore
     Qt5::DBus
     Qt5::Sql
     KF5::Solid
     ${XAPIAN_LIBRARIES}
-    baloocore
-    balooxapian
+    KF5::BalooCore
+    KF5::BalooXapian
 )
 
-set_target_properties(baloofiles PROPERTIES
+set_target_properties(KF5BalooFiles PROPERTIES
     VERSION ${BALOO_VERSION_STRING}
     SOVERSION ${BALOO_SOVERSION}
+    EXPORT_NAME BalooFiles
 )
+target_include_directories(KF5BalooFiles INTERFACE "$<INSTALL_INTERFACE:${KF5_INCLUDE_INSTALL_DIR}/Baloo>")
+
+generate_export_header(KF5BalooFiles BASE_NAME BALOO_FILE EXPORT_FILE_NAME file_export.h)
 
-generate_export_header(baloofiles BASE_NAME BALOO_FILE EXPORT_FILE_NAME file_export.h)
+install(TARGETS KF5BalooFiles ${INSTALL_TARGETS_DEFAULT_ARGS})
+install(TARGETS KF5BalooFiles EXPORT BalooLibraryTargets ${INSTALL_TARGETS_DEFAULT_ARGS})
 
-install(TARGETS baloofiles EXPORT BalooLibraryTargets ${INSTALL_TARGETS_DEFAULT_ARGS})
+ecm_generate_headers(KF5BalooFiles_HEADERS
+    HEADER_NAMES
+    File
+    FileFetchJob
+    FileModifyjob
+    FileMonitor
+    TagListJob
+    IndexerConfig
+
+    REQUIRED_HEADERS KF5BalooFiles_HEADERS
+)
 
 install(FILES
-    file.h
-    filefetchjob.h
-    filemodifyjob.h
-    filemonitor.h
-    taglistjob.h
-    indexerconfig.h
     ${CMAKE_CURRENT_BINARY_DIR}/file_export.h
-
-    DESTINATION ${INCLUDE_INSTALL_DIR}/baloo COMPONENT Devel
+    ${KF5BalooFiles_HEADERS}
+    DESTINATION ${KF5_INCLUDE_INSTALL_DIR}/Baloo COMPONENT Devel
 )
 
 add_subdirectory(tests)
diff --git a/src/file/lib/autotests/CMakeLists.txt b/src/file/lib/autotests/CMakeLists.txt
index 0c20b65..8176bc1 100644
--- a/src/file/lib/autotests/CMakeLists.txt
+++ b/src/file/lib/autotests/CMakeLists.txt
@@ -20,7 +20,7 @@ ecm_add_test(${filefetchjobtest_SRC}
         Qt5::Sql
         Qt5::DBus
         ${XAPIAN_LIBRARIES}
-        baloocore
+        KF5::BalooCore
 )
 
 #
@@ -45,8 +45,8 @@ ecm_add_test(${filemodifyjobtest_SRC}
         Qt5::Sql
         Qt5::DBus
         ${XAPIAN_LIBRARIES}
-        baloocore
-        balooxapian
+        KF5::BalooCore
+        KF5::BalooXapian
 )
 
 # Pass CMAKE_CURRENT_BINARY_DIR so tests can use it to create some of the
@@ -61,6 +61,6 @@ ecm_add_test(taglistjobtest.cpp
     TEST_NAME "taglistjobtest"
     LINK_LIBRARIES
         Qt5::Test
-        baloocore
-        baloofiles
+        KF5::BalooCore
+        KF5::BalooFiles
 )
diff --git a/src/xapian/CMakeLists.txt b/src/xapian/CMakeLists.txt
index 5fcfd09..cc8314f 100644
--- a/src/xapian/CMakeLists.txt
+++ b/src/xapian/CMakeLists.txt
@@ -6,19 +6,22 @@ set(XAPIAN_SRCS
     xapiandatabase.cpp
 )
 
-add_library(balooxapian SHARED ${XAPIAN_SRCS})
+add_library(KF5BalooXapian SHARED ${XAPIAN_SRCS})
 
-target_link_libraries(balooxapian PUBLIC
+add_library(KF5::BalooXapian ALIAS KF5BalooXapian)
+
+
+target_link_libraries(KF5BalooXapian PUBLIC
     Qt5::Core
     ${XAPIAN_LIBRARIES}
-    baloocore
+    KF5::BalooCore
 )
 
-set_target_properties(balooxapian PROPERTIES
+set_target_properties(KF5BalooXapian PROPERTIES
     VERSION ${BALOO_VERSION_STRING}
     SOVERSION ${BALOO_SOVERSION}
 )
 
-generate_export_header(balooxapian BASE_NAME BALOO_XAPIAN EXPORT_FILE_NAME xapian_export.h)
+generate_export_header(KF5BalooXapian BASE_NAME BALOO_XAPIAN EXPORT_FILE_NAME xapian_export.h)
 
-install(TARGETS balooxapian EXPORT BalooLibraryTargets ${INSTALL_TARGETS_DEFAULT_ARGS})
+install(TARGETS KF5BalooXapian EXPORT BalooLibraryTargets ${INSTALL_TARGETS_DEFAULT_ARGS})
-- 
2.0.0

