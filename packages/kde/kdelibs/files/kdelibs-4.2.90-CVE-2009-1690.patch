From 5ed3be6b3cff9b49dbe2522c070ce17da8c87fee Mon Sep 17 00:00:00 2001
From: mueller <mueller@283d02a7-25f6-0310-bc7c-ecb5cbfe19da>
Date: Wed, 17 Jun 2009 21:52:03 +0000
Subject: [PATCH 1/2] fix memory corruption vulnerability (CVE-2009-1690)

git-svn-id: svn://anonsvn.kde.org/home/kde/trunk/KDE/kdelibs@983301 283d02a7-25f6-0310-bc7c-ecb5cbfe19da
---
 khtml/svg/SVGList.h |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/khtml/svg/SVGList.h b/khtml/svg/SVGList.h
index 0422fd3..56b1970 100644
--- a/khtml/svg/SVGList.h
+++ b/khtml/svg/SVGList.h
@@ -97,7 +97,11 @@ namespace WebCore {
 
         Item insertItemBefore(Item newItem, unsigned int index, ExceptionCode&)
         {
-            m_vector.insert(index, newItem);
+            if (index < m_vector.size()) {
+                m_vector.insert(index, newItem);
+            } else {
+                m_vector.append(newItem);
+            }
             return newItem;
         }
 
-- 
1.6.3.2


From 132fdb5a775514bfa23e3b2c4e83c8b0c1f908a4 Mon Sep 17 00:00:00 2001
From: mueller <mueller@283d02a7-25f6-0310-bc7c-ecb5cbfe19da>
Date: Wed, 17 Jun 2009 22:59:13 +0000
Subject: [PATCH 2/2] fix crash on <head> occuring twice (CVE-2009-1690)

git-svn-id: svn://anonsvn.kde.org/home/kde/trunk/KDE/kdelibs@983315 283d02a7-25f6-0310-bc7c-ecb5cbfe19da
---
 khtml/html/htmlparser.cpp |   12 +++++-------
 khtml/html/htmlparser.h   |    2 +-
 2 files changed, 6 insertions(+), 8 deletions(-)

diff --git a/khtml/html/htmlparser.cpp b/khtml/html/htmlparser.cpp
index f319a9b..c59a3c6 100644
--- a/khtml/html/htmlparser.cpp
+++ b/khtml/html/htmlparser.cpp
@@ -216,7 +216,6 @@ void KHTMLParser::reset()
 
     form = 0;
     map = 0;
-    head = 0;
     end = false;
     isindex = 0;
 
@@ -678,8 +677,7 @@ bool KHTMLParser::insertNode(NodeImpl *n, bool flat)
             case ID_BASE:
                 if(!head) {
                     head = new HTMLHeadElementImpl(document);
-                    e = head;
-                    insertNode(e);
+                    insertNode(head.get());
                     handled = true;
                 }
                 break;
@@ -894,7 +892,7 @@ NodeImpl *KHTMLParser::getElement(Token* t)
     case ID_HEAD:
         if(!head && (current->id() == ID_HTML || current->isDocumentNode())) {
             head = new HTMLHeadElementImpl(document);
-            n = head;
+            n = head.get();
         }
         break;
     case ID_BODY:
@@ -1907,19 +1905,19 @@ void KHTMLParser::createHead()
     head = new HTMLHeadElementImpl(document);
     HTMLElementImpl *body = doc()->body();
     int exceptioncode = 0;
-    doc()->documentElement()->insertBefore(head, body, exceptioncode);
+    doc()->documentElement()->insertBefore(head.get(), body, exceptioncode);
     if ( exceptioncode ) {
 #ifdef PARSER_DEBUG
         kDebug( 6035 ) << "creation of head failed!!!!:" << exceptioncode;
 #endif
-        delete head;
+        delete head.get();
         head = 0;
     }
         
     // If the body does not exist yet, then the <head> should be pushed as the current block.
     if (head && !body) {
         pushBlock(head->id(), tagPriority(head->id()));
-        setCurrent(head);
+        setCurrent(head.get());
     }
 }
 
diff --git a/khtml/html/htmlparser.h b/khtml/html/htmlparser.h
index 1838e45..ce5f9a8 100644
--- a/khtml/html/htmlparser.h
+++ b/khtml/html/htmlparser.h
@@ -157,7 +157,7 @@ private:
     /*
      * the head element. Needed for crappy html which defines <base> after </head>
      */
-    DOM::HTMLHeadElementImpl *head;
+    RefPtr<DOM::HTMLHeadElementImpl> head;
 
     /*
      * a possible <isindex> element in the head. Compatibility hack for
-- 
1.6.3.2

