From d593a137ad9c9c264eac7d99520624e58843df42 Mon Sep 17 00:00:00 2001
From: kossebau <kossebau@283d02a7-25f6-0310-bc7c-ecb5cbfe19da>
Date: Sun, 8 Aug 2010 00:41:23 +0000
Subject: [PATCH] backport of 1160390:fixed: start call to cagibi only in next event loop, could be started in on-demand load by a d-bus call ourself, so d-bus connection has a mutex locked already

git-svn-id: svn+ssh://svn.kde.org/home/kde/branches/KDE/4.5/kdebase/runtime@1160391 283d02a7-25f6-0310-bc7c-ecb5cbfe19da
---
 .../network/builder/upnp/upnpnetworkbuilder.cpp    |    6 ++++++
 .../network/builder/upnp/upnpnetworkbuilder.h      |    2 ++
 2 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/kioslave/network/network/builder/upnp/upnpnetworkbuilder.cpp b/kioslave/network/network/builder/upnp/upnpnetworkbuilder.cpp
index 857c919..9492d99 100644
--- a/kioslave/network/network/builder/upnp/upnpnetworkbuilder.cpp
+++ b/kioslave/network/network/builder/upnp/upnpnetworkbuilder.cpp
@@ -36,6 +36,7 @@
 #include <QtDBus/QDBusConnection>
 #include <QtDBus/QDBusInterface>
 #include <QtDBus/QDBusPendingCallWatcher>
+#include <QtCore/QTimer>
 #include <QtCore/QStringList>
 
 #include <KDebug>
@@ -60,6 +61,11 @@ void UpnpNetworkBuilder::registerNetSystemFactory( AbstractNetSystemFactory* net
 
 void UpnpNetworkBuilder::start()
 {
+    QTimer::singleShot(0, this, SLOT(startBrowse()));
+}
+
+void UpnpNetworkBuilder::startBrowse()
+{
     qDBusRegisterMetaType<DeviceTypeMap>();
     qDBusRegisterMetaType<Cagibi::Device>();
 
diff --git a/kioslave/network/network/builder/upnp/upnpnetworkbuilder.h b/kioslave/network/network/builder/upnp/upnpnetworkbuilder.h
index 3df90e1..7043cd5 100644
--- a/kioslave/network/network/builder/upnp/upnpnetworkbuilder.h
+++ b/kioslave/network/network/builder/upnp/upnpnetworkbuilder.h
@@ -63,6 +63,8 @@ class UpnpNetworkBuilder : public AbstractNetworkBuilder
     void removeUPnPDevices( const QList<Cagibi::Device>& devices );
 
   private Q_SLOTS:
+    void startBrowse();
+
     void onDevicesAdded( const DeviceTypeMap& deviceTypeMap );
     void onDevicesRemoved( const DeviceTypeMap& deviceTypeMap );
     void onAddedDeviceDetails( const Cagibi::Device& device );
-- 
1.7.2.1

