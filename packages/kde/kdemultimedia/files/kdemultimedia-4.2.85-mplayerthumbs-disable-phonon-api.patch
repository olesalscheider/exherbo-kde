From 1dce1ec2ce5eacc2d522763a4db121fca2e7eca4 Mon Sep 17 00:00:00 2001
From: mueller <mueller@283d02a7-25f6-0310-bc7c-ecb5cbfe19da>
Date: Fri, 8 May 2009 14:12:14 +0000
Subject: [PATCH] merge 964873

git-svn-id: svn://anonsvn.kde.org/home/kde/tags/KDE/4.2.85/kdemultimedia@965319 283d02a7-25f6-0310-bc7c-ecb5cbfe19da
---
 mplayerthumbs/CMakeLists.txt                   |    1 +
 mplayerthumbs/src/CMakeLists.txt               |   33 +++++++++++++++++++++--
 mplayerthumbs/src/mplayerthumbs-config.h.cmake |    2 +
 mplayerthumbs/src/servicesfactory.cpp          |   13 ++++++++-
 4 files changed, 45 insertions(+), 4 deletions(-)
 create mode 100644 mplayerthumbs/src/mplayerthumbs-config.h.cmake

diff --git a/mplayerthumbs/CMakeLists.txt b/mplayerthumbs/CMakeLists.txt
index 3e343a8..bc061ee 100644
--- a/mplayerthumbs/CMakeLists.txt
+++ b/mplayerthumbs/CMakeLists.txt
@@ -1,2 +1,3 @@
 project(mplayerthumbs)
+
 add_subdirectory( src )
diff --git a/mplayerthumbs/src/CMakeLists.txt b/mplayerthumbs/src/CMakeLists.txt
index 9b5a077..f8c4c5b 100644
--- a/mplayerthumbs/src/CMakeLists.txt
+++ b/mplayerthumbs/src/CMakeLists.txt
@@ -1,10 +1,37 @@
-set(videopreview_PART_SRCS frameselector.cpp phononbackend.cpp videopreview.cpp  mplayervideobackend.cpp videobackendiface.cpp previewingfile.cpp thumbnail.cpp thumbnailsmap.cpp servicesfactory.cpp)
+include_directories( ${CMAKE_CURRENT_BINARY_DIR} )
 
-kde4_add_kcfg_files(videopreview_PART_SRCS mplayerthumbs.kcfgc)
+set(PHONON_API FALSE)
+
+if(ENABLE_PHONON_SUPPORT)
+	set(PHONON_API TRUE)
+endif(ENABLE_PHONON_SUPPORT)
+
+configure_file(mplayerthumbs-config.h.cmake ${CMAKE_CURRENT_BINARY_DIR}/mplayerthumbs-config.h )
+
+set(videopreview_PART_SRCS 
+	frameselector.cpp 
+	videopreview.cpp  
+	mplayervideobackend.cpp 
+	videobackendiface.cpp 
+	previewingfile.cpp 
+	thumbnail.cpp 
+	thumbnailsmap.cpp 
+	servicesfactory.cpp)
 
+if( PHONON_API )
+	set( videopreview_PART_SRCS
+		${videopreview_PART_SRCS}
+		phononbackend.cpp )
+endif( PHONON_API )
+
+kde4_add_kcfg_files(videopreview_PART_SRCS mplayerthumbs.kcfgc)
 kde4_add_plugin(videopreview ${videopreview_PART_SRCS})
 
-target_link_libraries(videopreview ${KDE4_KIO_LIBS} ${PHONON_LIBRARY} )
+target_link_libraries(videopreview ${KDE4_KIO_LIBS} )
+
+if( PHONON_API )
+	target_link_libraries(videopreview ${PHONON_LIBRARY} )
+endif( PHONON_API )
 
 install(TARGETS videopreview DESTINATION ${PLUGIN_INSTALL_DIR})
 
diff --git a/mplayerthumbs/src/mplayerthumbs-config.h.cmake b/mplayerthumbs/src/mplayerthumbs-config.h.cmake
new file mode 100644
index 0000000..9bb7faf
--- /dev/null
+++ b/mplayerthumbs/src/mplayerthumbs-config.h.cmake
@@ -0,0 +1,2 @@
+/* If phonon support is enabled */
+#cmakedefine PHONON_API 1
diff --git a/mplayerthumbs/src/servicesfactory.cpp b/mplayerthumbs/src/servicesfactory.cpp
index 75fb521..a7ba2d4 100644
--- a/mplayerthumbs/src/servicesfactory.cpp
+++ b/mplayerthumbs/src/servicesfactory.cpp
@@ -16,13 +16,20 @@
    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
    Boston, MA 02110-1301, USA.
 */
+
 #include "constants.h"
 #include "servicesfactory.h"
 #include "previewingfile.h"
 #include "videobackendiface.h"
 #include "mplayervideobackend.h"
 #include "mplayerthumbs.h"
-#include "phononbackend.h"
+#include "mplayerthumbs-config.h"
+
+
+#ifdef PHONON_API
+	#include "phononbackend.h"
+#endif
+
 PreviewingFile* ServicesFactory::previewingFile(const QString& filePath, unsigned int scalingWidth, unsigned int scalingHeight, QObject* parent) {
   return new PreviewingFile(filePath, scalingWidth, scalingHeight, parent);
 }
@@ -33,9 +40,13 @@ VideoBackendIFace *ServicesFactory::videoBackend(PreviewingFile* previewingFile,
     case VideoBackendIFace::MPlayer:
       kDebug(DBG_AREA) << "videopreview: Selected mplayer backend\n";
       return new MPlayerVideoBackend(previewingFile, cfg);
+	  break;
+#ifdef PHONON_API
     case VideoBackendIFace::Phonon:
       kDebug(DBG_AREA) << "videopreview: Selected phonon backend\n";
       return new PhononBackend(previewingFile, cfg);
+	  break;
+#endif
   }
   // Well, we should never be here...
   return NULL;
-- 
1.6.3

